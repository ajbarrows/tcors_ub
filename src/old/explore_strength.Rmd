---
title: "R Notebook"
output: html_notebook
---

```{r}
# setup
library(dplyr)
library(ggplot2)

theme_set(theme_classic())

# load data
load("../../data/clean/s2_data.RData")
```



## Usual Brand

In addition to "traditional" baseline characteristics used when modelling smoking behavior, we also collected information about the participant's choice of usual brand. Many of us hypothesized that participant response to VLNCs would be heavily moderated by their choice of usual brand cigarette, which are known to vary widely in their nicotine content (example: [Taghavi, et al.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3905555/)) and, more subjectively, their "strength" (example [Felcione, et al.](http://www.tobaccopreventioncessation.com/Smokers-perceptions-of-different-classes-of-cigarette-brand-descriptors,131243,0,2.html)). 

A couple of us labeled this data set years ago with each usual brand strength:

```{r echo=FALSE}
df %>%
  distinct(screen_id, .keep_all = TRUE) %>%
  group_by(strength) %>%
  mutate(usual_brand = factor(usual_brand)) %>%
  filter(!is.na(strength), !strength == "") %>%
  count() %>% 
  ungroup() %>%
  mutate(pct = n / sum(n) * 100 ) %>%
  ggplot(aes(x = reorder(strength, -pct)  , y = pct, fill = strength)) +
  geom_col() +
  labs(
    x = "Cigarette Strength",
    y = "Percent of Sample",
    title = "Distribution of Usual Brand Strength Preference"
  )
  
```


### Caveats:

* "Strength" is somewhat arbitrary and only loosely tied to something more concrete and ordinal like nicotine content
* The effect of "strength" on cigarettes per day is not an especially well-informed hypothesis


### Repeat model in only largest group

```{r}
# limit to "regular" strength
df_limited <- df %>%
  filter(strength == "regular") %>%
  group_by(screen_id, dose, screen_age, week) %>%
  summarize(
    across(
      c(experimental_cpd, baseline_cpd),
      list(mean = mean),
      na.rm = TRUE
  ),
  .groups = "keep")

df_lim_w12 <- df_limited %>% filter(week == "week12")
nrow(df_lim_w12)
```


```{r}
ancova_fm_red <- experimental_cpd_mean ~ dose + baseline_cpd_mean
ancova_limited <- lm(ancova_fm_red, data = df_limited)
summary(ancova_limited)
adj_ancova <- lm(ancova_fm_red, data = df_limited)
car::Anova(adj_ancova, type = 3)

# post-hoc
pair_test <- pairwise.t.test(
  df_limited$experimental_cpd_mean,
  df_limited$dose, 
  p.adjust.method = "bonf"
  )
pair_test$p.value
```


```{r}
car::Anova(adj_ancova, type = 3)
car::Anova(ancova_limited, type = 3)
```


The effect holds and strengthens. There is now a significant difference between the two VLNC conditions.

```{r}
predict_summary_w12 <- function(model, df, title) {
    pred <- as.data.frame(predict(model, df, interval = "confidence"))
  df_predict <- cbind(
    df, 
    "adj_mean_cpd" = pred$fit,
    "adj_lwrCI" = pred$lwr,
    "adj_uprCI" = pred$upr
  )
  summary_vals <- df_predict %>%
    group_by(dose) %>%
    summarize(
      across(c(adj_mean_cpd, adj_lwrCI, adj_uprCI),
             list(mean = mean))
    )
  p <- df_predict %>%
    ggplot(aes(x = dose, y = adj_mean_cpd, color = dose, fill = dose)) +
    geom_boxplot(show.legend = FALSE) +
    annotate("text", x = 1, y = 70, label = "*", size = 5) +
    annotate("text", x = 2, y = 70, label = "*", size = 5) +
    labs(
      y = "Adjusted Mean CPD at Week 12",
      x = "Cigarette Nicotine Dose (mg/g)",
      title = title
    )
  
  list(
    "plot" = p,
    "summary_vals" = summary_vals)

}

pred_limited <- predict_summary_w12(
  ancova_limited, 
  df_lim_w12, 
  "Adjusted Week 12 Total CPD - Regular Strength Smokers"
  )
pred_limited$plot
```

```{r}
pred_limited$summary_vals
```


### Repeat model, but use UB strength as a covariate

```{r}
df_strength <- df %>%
  group_by(screen_id, dose, screen_age, week, strength) %>%
  summarize(
    across(
      c(experimental_cpd, baseline_cpd),
      list(mean = mean),
      na.rm = TRUE
  ),
  .groups = "keep")

df_strength_w12 <- df_strength %>% filter(week == "week12")


ancova_fm_strength <- experimental_cpd_mean ~ dose + baseline_cpd_mean + strength
ancova_strength <- lm(ancova_fm_strength, data = df_strength_w12)
# summary(ancova_strength)
car::Anova(ancova_strength, type = 3)
```


Not significant.

<br>
<br>
<br>
<br>
