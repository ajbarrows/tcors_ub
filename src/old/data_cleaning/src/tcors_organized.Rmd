---
title: "TCORS Data (Semi-Organized)"
author: Tony Barrows
output: html_document
date: "2022-09-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
# setup
library(dplyr)
library(ggplot2)
library(ggalluvial)

theme_set(theme_classic())

# load data
load("../clean/s2_data.RData")
write.csv(df, "../clean/s2_data.csv", row.names = FALSE)
```

## TCORS "Study 2" Data


The UVM "TCORS" (Tobacco Centers on Regulatory Science) site is focused on modelling the implications of a potential nicotine-reduction standard. In particular, this group is interested in how a switch to very-low-nicotine cigarettes (VLNCs) will affect smokers from vulnerable populations: (1) low-SES women, (2) smokers with opiate use disorder, and (3) smokers with serious depression and anxiety. 

Participants from each of these groups were randomly assigned to smoke study-provided cigarettes with either 0.4 mg nicotine / g tobacco (very low nicotine), 2.4 mg/g (low nicotine), or 15.8 mg/g (normal nicotine - control group). Week-12 total cigarettes per day (CPD) was considered the primary outcome. CPD was assessed daily and, for analysis, collapsed across populations. 

The [primary results](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7576411/) showed significantly decreased mean total CPD in the VLNC and LNC groups relative to the normal nicotine group.


## General Info


```{r}
n_pts <- df %>% distinct(screen_id) %>% nrow()
n_wk12 <- df %>% filter(week == "week12") %>% nrow()
```


*  `r n_pts` were randomized to receive one of three cigarettes
*  Of those, `r n_wk12` have primary outcome (i.e., cigarettes per day at trial Week 12) available:

```{r}
df %>% filter(week == "week12") %>% 
  group_by(dose) %>% 
  count() %>% 
  ungroup() %>%
  mutate(`%` = round(n / sum(n) * 100, 2)) %>%
  knitr::kable()
```



### Repeating Trial's Initial Analysis

```{r}
# average by treatment group by week
# df_sum <- df %>%
#   group_by(screen_id, dose, week, project, screen_sex, menthol_status) %>%
#   summarize(
#     across(
#       c(experimental_cpd, baseline_cpd, screen_age),
#       list(mean = mean),
#       na.rm = TRUE
#   ))
# 
# 
# # pull out primary outcome
# df_primary <- df_sum %>% filter(week == "week12")
# 
# # ANCOVA for total CPD at week 12
# 
# ancova_fm <- experimental_cpd_mean ~ dose + project + screen_sex + menthol_status + screen_age_mean + baseline_cpd_mean
# orig_ancova <- aov(ancova_fm, data = df_primary)
# car::Anova(orig_ancova, type = 3)
```


... skip a bit ... 

The original trial's primary analysis used analysis of covariance to determine significant differences in Week 12 CPD while controllign for baseline characteristics (i.e., vulnerable population, sex, age, choice of menthol or non-menthol cigarette, and baseline smoking rate).  We can replicate this analysis here:


```{r}

# remove non-significant predictors
df_sum_final <- df %>%
  group_by(screen_id, dose, screen_age, week) %>%
  summarize(
    across(
      c(experimental_cpd, baseline_cpd),
      list(mean = mean),
      na.rm = TRUE
  ),
  .groups = "keep")

df_final <- df_sum_final %>% filter(week == "week12")
ancova_fm_red <- experimental_cpd_mean ~ dose + baseline_cpd_mean
adj_ancova <- lm(ancova_fm_red, data = df_final)

# summary(adj_ancova)
car::Anova(adj_ancova, type = 3)
```




```{r}
# post-hoc comparison
pair_test <- pairwise.t.test(
  df_final$experimental_cpd_mean,
  df_final$dose, 
  p.adjust.method = "bonf"
  )
pair_test$p.value
```



```{r echo=FALSE}
# summarize data without non-significant predictors
pred <- as.data.frame(predict(adj_ancova, df_final, interval = "confidence"))
df_predict <- cbind(
  df_final, 
  "adj_mean_cpd" = pred$fit,
  "adj_lwrCI" = pred$lwr,
  "adj_uprCI" = pred$upr
)

# df_predict %>%
#   group_by(dose) %>%
#   summarize(
#     across(c(adj_mean_cpd, adj_lwrCI, adj_uprCI),
#            list(mean = mean))
#   )

df_predict %>%
  ggplot(aes(x = dose, y = adj_mean_cpd, color = dose, fill = dose)) +
  geom_boxplot(show.legend = FALSE) +
  annotate("text", x = 1, y = 70, label = "*", size = 5) +
  annotate("text", x = 2, y = 70, label = "*", size = 5) +
  labs(
    y = "Adjusted Mean CPD at Week 12",
    x = "Cigarette Nicotine Dose (mg/g)",
    title = "Adjusted Week 12 Total CPD"
  )
```


when adjusting for baseline CPD, each VLNC group smoked significantly less at Week 12 compared to the normal nicotine group, but not differently from one another.


## Usual Brand

In addition to "traditional" baseline characteristics used when modelling smoking behavior, we also collected information about the participant's choice of usual brand. Many of us hypothesized that participant response to VLNCs would be heavily moderated by their choice of usual brand cigarette, which are known to vary widely in their nicotine content (example: [Taghavi, et al.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3905555/)) and, more subjectively, their "strength" (example [Felcione, et al.](http://www.tobaccopreventioncessation.com/Smokers-perceptions-of-different-classes-of-cigarette-brand-descriptors,131243,0,2.html)). 

A couple of us labeled this data set years ago with each usual brand strength:

```{r echo=FALSE}
df %>%
  distinct(screen_id, .keep_all = TRUE) %>%
  group_by(strength) %>%
  mutate(usual_brand = factor(usual_brand)) %>%
  filter(!is.na(strength), !strength == "") %>%
  count() %>% 
  ungroup() %>%
  mutate(pct = n / sum(n) * 100 ) %>%
  ggplot(aes(x = reorder(strength, -pct)  , y = pct, fill = strength)) +
  geom_col() +
  labs(
    x = "Cigarette Strength",
    y = "Percent of Sample",
    title = "Distribution of Usual Brand Strength Preference"
  )
  
```


### Caveats:

* "Strength" is somewhat arbitrary and only loosely tied to something more concrete and ordinal like nicotine content
* The effect of "strength" on cigarettes per day is not an especially well-informed hypothesis


<br>
<br>
<br>
<br>


